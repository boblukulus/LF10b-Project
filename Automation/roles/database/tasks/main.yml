---

- name: Sicherstellen das MariaDB installiert ist
  ansible.builtin.package:
    name: mariadb-server
    state: present

- name: Sicherstellen das MariaDB aktiv ist
  ansible.builtin.service:
    name: mariadb
    enabled: true
    state: started

- name: Pterodactyl Datenbank erstellen
  community.mysql.mysql_db:
    name: "{{ pterodactyl.db_name }}"
    state: present
    login_user: root
    login_password: "{{ pterodactyl.mariadb_root_password }}"

- name: Erstellen Pterodactyl Nutzer
  community.mysql.mysql_user:
    name: "{{ pterodactyl.db_name }}"
    password: "{{ pterodactyl.db_password }}"
    priv: '{{ pterodactyl.db_password }}.*:ALL'
    host: "%"
    state: present
    login_user: root
    login_password: "{{ pterodactyl.mariadb_root_password }}"

- name: Sicherstellen dass der Pterodactyl Nutzer sich mit dem localhost verbinden kann
  community.mysql.mysql_user:
    name: "{{ pterodactyl.db_name }}"
    password: "{{ pterodactyl.db_password }}"
    priv: '{{ pterodactyl.db_password }}.*:ALL'
    host: "localhost"
    state: present
    login_user: root
    login_password: "{{ pterodactyl.mariadb_root_password }}"

- name: Kopieren von Default Umgebungseinstellungen
  ansible.builtin.copy:
    src: /var/www/pterodactyl/.env.example
    dest: /var/www/pterodactyl/.env
    remote_src: yes

- name: Installieren von Kern Abh채ngigkeiten
  ansible.builtin.shell:
    cmd: COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader
    chdir: /var/www/pterodactyl

- name: Kopieren der .env Datei
  ansible.builtin.template:
    src: pterodactyl.env.j2
    dest: /var/www/pterodactyl/.env
    mode: "0664"

- name: Pr체fen ob der APP_KEY in .env existiert
  ansible.builtin.shell:
  register: app_key_check
  ignore_errors: true

- name: Generieren eines neuen App Key
  ansible.builtin.shell:
    cmd: php artisan key:generate --force
    chdir: /var/www/pterodactyl
  when: app_key_check.rc != 0

- name: Einlesen des App Key aus der .env file
  ansible.builtin.shell: "grep -oP '(?<=^APP_KEY=).*' /var/www/pterodactyl/.env"
  register: app_key_output

- name: String auf den Backup Server verschieben
  ansible.builtin.lineinfile:
    path: /home/luis/backup/key.txt     # Hier den korrekten Speicherort einf체gen wo die Datei auf dem Backup Server gespeichert werden soll
    line: "{{ app_key_output.stdout }}"
    state: present
    create: true
  delegate_to: 192.168.0.43             # IP des Backup Server angeben
  run_once: true                        # Stellt sicher dass die task nur einmal durchl채uft

- name: Datenbank Migration und Seed
  ansible.builtin.command: php artisan migrate --seed --force
  args: 
    chdir: /var/www/pterodactyl
    creates: /var/www/pterodactyl/database/.migrations_done
  register: migrate_result

- name: Erstellt Markerdatei
  ansible.builtin.file:
    path: /var/www/pterodactyl/database/.migrations_done
    state: touch
  when: migrate_result is changed
